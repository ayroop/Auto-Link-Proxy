# راهنمای کامل نصب و راه‌اندازی سیستم پروکسی

## 📋 خلاصه پروژه

این سیستم شامل فایل‌های زیر است که برای دور زدن محدودیت دانلود کاربران ایرانی از سرور خارجی طراحی شده:

### فایل‌های اصلی:
- **`proxy.php`** - اسکریپت اصلی پروکسی
- **`config.php`** - تنظیمات مرکزی سیستم
- **`link_rewriter.php`** - بازنویسی خودکار لینک‌ها
- **`test_proxy.html`** - صفحه تست عملکرد
- **`README.md`** - مستندات اصلی

### اطلاعات سرور:
- **دامنه:** filmkhabar.space
- **IP اختصاصی:** 45.12.143.141
- **پینگ:** ~178ms (متوسط)

---

## 🚀 مراحل نصب

### مرحله 1: آپلود فایل‌ها
1. تمام فایل‌ها را در ریشه سایت ایران (`filmkhabar.space`) آپلود کنید
2. مطمئن شوید که مجوزهای فایل درست تنظیم شده‌اند:
   ```bash
   chmod 644 *.php *.html *.md
   chmod 664 proxy.log
   ```

### مرحله 2: تنظیم دامنه
در فایل `config.php` تنظیمات زیر را بررسی کنید:
```php
const PROXY_DOMAIN = 'filmkhabar.space'; // دامنه واقعی شما
const PROXY_IP = '45.12.143.141'; // IP اختصاصی شما
const USE_IP_INSTEAD_OF_DOMAIN = false; // true برای استفاده از IP
```

### مرحله 3: تست اولیه
1. فایل `test_proxy.html` را در مرورگر باز کنید
2. روی لینک‌های تست کلیک کنید
3. بررسی کنید که فایل‌ها دانلود می‌شوند

---

## ⚙️ تنظیمات پیشرفته

### انتخاب بین دامنه و IP:

#### استفاده از دامنه (پیشنهادی):
```php
const USE_IP_INSTEAD_OF_DOMAIN = false;
```
**مزایا:**
- آدرس‌های قابل خواندن
- امکان تغییر IP بدون تغییر لینک‌ها
- SSL certificate آسان‌تر

#### استفاده از IP:
```php
const USE_IP_INSTEAD_OF_DOMAIN = true;
```
**مزایا:**
- سرعت کمی بیشتر
- عدم وابستگی به DNS
- مناسب برای تست‌های سریع

### تنظیمات امنیتی در `config.php`:

```php
// محدودیت IP (اختیاری)
const ALLOWED_IPS = [
    '192.168.1.1',
    '10.0.0.1',
];

// محدودیت اندازه فایل
const MAX_FILE_SIZE = 2 * 1024 * 1024 * 1024; // 2 گیگابایت

// نوع فایل‌های مجاز
const ALLOWED_EXTENSIONS = [
    'mp4', 'avi', 'mkv', 'mov', 'zip', 'rar', 'pdf'
];
```

### تنظیمات لاگ‌گیری:
```php
// فعال/غیرفعال کردن لاگ
const LOG_ENABLED = true;

// حداکثر اندازه فایل لاگ
const MAX_LOG_SIZE = 10 * 1024 * 1024; // 10 مگابایت
```

---

## 🔗 نحوه استفاده

### روش 1: لینک مستقیم
```
https://filmkhabar.space/proxy.php?url=https://sv1.cinetory.space/h2/movie/file.mp4
```
یا با IP:
```
https://45.12.143.141/proxy.php?url=https://sv1.cinetory.space/h2/movie/file.mp4
```

### روش 2: بازنویسی خودکار
در فایل‌های PHP سایت خود:
```php
<?php
require_once 'link_rewriter.php';
?>
<!DOCTYPE html>
<html>
<body>
    <!-- این لینک‌ها خودکار به پروکسی تبدیل می‌شوند -->
    <a href="https://sv1.cinetory.space/h2/movie/file.mp4">دانلود</a>
</body>
</html>
```

### روش 3: JavaScript
در صفحات HTML:
```html
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('a[href*="sv1.cinetory.space"]').forEach(function(a) {
        a.href = 'https://filmkhabar.space/proxy.php?url=' + encodeURIComponent(a.href);
    });
});
</script>
```

---

## 🛡️ امنیت

### ویژگی‌های امنیتی:
- ✅ فیلتر بر اساس دامنه
- ✅ محدودیت نوع فایل
- ✅ محدودیت اندازه فایل
- ✅ محدودیت IP (اختیاری)
- ✅ لاگ‌گیری کامل
- ✅ چرخش خودکار لاگ

### توصیه‌های امنیتی:
1. **HTTPS**: حتماً از HTTPS استفاده کنید
2. **فایروال**: در صورت امکان فایروال سرور را فعال کنید
3. **محدودیت IP**: برای سایت‌های خصوصی محدودیت IP تنظیم کنید
4. **نظارت**: لاگ‌ها را مرتب بررسی کنید

---

## 🐞 عیب‌یابی

### مشکلات رایج:

#### خطای "دامنه غیرمجاز"
- بررسی کنید که `ALLOWED_HOSTS` در `config.php` درست تنظیم شده
- مطمئن شوید که دامنه با حروف کوچک/بزرگ درست نوشته شده

#### خطای "اتصال ناموفق"
- بررسی کنید که cURL روی سرور فعال است
- مطمئن شوید که سرور خارجی در دسترس است
- بررسی کنید که فایروال سرور مسدود نکرده

#### خطای "فایل خیلی بزرگ"
- تنظیمات `MAX_FILE_SIZE` در `config.php` را بررسی کنید
- محدودیت‌های PHP (`memory_limit`, `max_execution_time`) را چک کنید

#### لاگ‌گیری کار نمی‌کند
- مجوزهای فایل `proxy.log` را بررسی کنید
- مطمئن شوید که `LOG_ENABLED = true` است

---

## 📊 نظارت و نگهداری

### بررسی لاگ‌ها:
```bash
# مشاهده لاگ‌های زنده
tail -f proxy.log

# جستجو در لاگ‌ها
grep "خطا" proxy.log

# آمار درخواست‌ها
grep "درخواست پروکسی جدید" proxy.log | wc -l
```

### نگهداری:
1. **چرخش لاگ**: سیستم خودکار لاگ را چرخش می‌دهد
2. **نظارت بر فضای دیسک**: مرتب فضای دیسک را چک کنید
3. **بروزرسانی**: کد را مرتب بررسی و بروزرسانی کنید

---

## 🔧 بهینه‌سازی

### تنظیمات عملکرد:
```php
// اندازه بافر استریم
const STREAM_BUFFER_SIZE = 16384; // افزایش برای سرعت بیشتر

// محدودیت حافظه
const MEMORY_LIMIT = '512M'; // افزایش برای فایل‌های بزرگ

// Timeout
const CURL_TIMEOUT = 60; // افزایش برای فایل‌های بزرگ
```

### توصیه‌های بهینه‌سازی:
1. **CDN**: برای ترافیک بالا از CDN استفاده کنید
2. **کش**: در صورت امکان کش سرور را فعال کنید
3. **فشرده‌سازی**: فشرده‌سازی gzip را فعال کنید

---

## 📞 پشتیبانی

### اطلاعات مفید برای عیب‌یابی:
- نسخه PHP: `<?php echo phpversion(); ?>`
- افزونه‌های فعال: `<?php print_r(get_loaded_extensions()); ?>`
- تنظیمات cURL: `<?php print_r(curl_version()); ?>`

### نکات مهم:
- سیستم فقط روی هاست ایران اجرا می‌شود
- هیچ تغییری در سرور خارجی نیاز نیست
- تمام تنظیمات در `config.php` متمرکز شده
- سیستم با PHP 7.4+ سازگار است
- امکان استفاده از دامنه یا IP اختصاصی

---

## 📄 مجوز

این پروژه تحت مجوز MIT ارائه می‌شود. استفاده تجاری مجاز است. 